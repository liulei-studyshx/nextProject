<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers 绘制正方形</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button onclick="enableDraw()">开始绘制正方形</button>
    <button onclick="disableDraw()">停止绘制</button>

    <script>
        // 创建地图
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([120, 30]), // 设置地图中心坐标
                zoom: 5
            })
        });

        // 创建矢量图层
        const source = new ol.source.Vector();
        const vectorLayer = new ol.layer.Vector({
            source: source,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'red',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255, 0, 0, 0.3)'
                })
            })
        });
        map.addLayer(vectorLayer);

        let draw; // 绘制交互对象

        // **自定义正方形绘制函数**
        function createSquareGeometryFunction() {
            return function (coordinates, geometry) {
                if (!geometry) {
                    geometry = new ol.geom.Polygon([]);
                }
                const start = coordinates[0];
                const end = coordinates[1];

                const dx = end[0] - start[0];
                const dy = end[1] - start[1];

                // 取长和宽的最大值，使其变为正方形
                const side = Math.max(Math.abs(dx), Math.abs(dy));

                // 计算正方形的四个顶点
                const xSign = dx < 0 ? -1 : 1;
                const ySign = dy < 0 ? -1 : 1;

                const newEndX = start[0] + xSign * side;
                const newEndY = start[1] + ySign * side;

                geometry.setCoordinates([[
                    start, 
                    [start[0], newEndY], 
                    [newEndX, newEndY], 
                    [newEndX, start[1]], 
                    start  // 关闭多边形
                ]]);

                return geometry;
            };
        }

        // 启用正方形绘制
        function enableDraw() {
            disableDraw(); // 移除已有的绘制
            draw = new ol.interaction.Draw({
                source: source,
                type: 'LineString', // 使用 LineString 绘制，后续转换为正方形
                geometryFunction: createSquareGeometryFunction(),
                maxPoints: 2 // 仅允许两点确定正方形
            });
            map.addInteraction(draw);
        }

        // 禁用绘制
        function disableDraw() {
            if (draw) {
                map.removeInteraction(draw);
                draw = null;
            }
        }
    </script>
</body>
</html>
